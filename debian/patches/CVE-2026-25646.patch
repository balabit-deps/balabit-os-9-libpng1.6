Backport of:

From 01d03b8453eb30ade759cd45c707e5a1c7277d88 Mon Sep 17 00:00:00 2001
From: Cosmin Truta <ctruta@gmail.com>
Date: Fri, 6 Feb 2026 19:11:54 +0200
Subject: [PATCH] Fix a heap buffer overflow in `png_set_quantize`

The color distance hash table stored the current palette indices, but
the color-pruning loop assumed the original indices. When colors were
eliminated and indices changed, the stored indices became stale. This
caused the loop bound `max_d` to grow past the 769-element hash array.

The fix consists in storing the original indices via `palette_to_index`
to match the pruning loop's expectations.

Reported-by: Joshua Inscoe <pwnalone@users.noreply.github.com>
Co-authored-by: Joshua Inscoe <pwnalone@users.noreply.github.com>
Signed-off-by: Cosmin Truta <ctruta@gmail.com>
---
 AUTHORS    | 1 +
 pngrtran.c | 6 +++---
 2 files changed, 4 insertions(+), 3 deletions(-)

#--- a/AUTHORS
#+++ b/AUTHORS
#@@ -16,6 +16,7 @@ Authors, for copyright and licensing pur
#  * Guy Eric Schalnat
#  * James Yu
#  * John Bowler
#+ * Joshua Inscoe
#  * Kevin Bracey
#  * Magnus Holmgren
#  * Mandar Sahastrabuddhe
--- a/pngrtran.c
+++ b/pngrtran.c
@@ -642,8 +642,8 @@ png_set_quantize(png_structrp png_ptr, p
                          break;
 
                      t->next = hash[d];
-                     t->left = (png_byte)i;
-                     t->right = (png_byte)j;
+                     t->left = png_ptr->palette_to_index[i];
+                     t->right = png_ptr->palette_to_index[j];
                      hash[d] = t;
                   }
                }
